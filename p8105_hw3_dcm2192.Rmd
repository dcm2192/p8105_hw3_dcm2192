---
title: "p8105_hw3_dcm2192"
author: "Dylan Morgan"
date: "2024-10-14"
output: github_document
---

```{r setup, message = FALSE}
library(tidyverse)
library(tidyr)
library(ggridges)
library(patchwork)
library(p8105.datasets)
```

This code contains my answers to P8105 HW 3. 

## Problem 1

Load NY NOAA dataset.
```{r}
data("ny_noaa")
```

The `ny_noaa` dataset is comprised of `r nrow(ny_noaa)` observations of `r ncol(ny_noaa)` variables. Its variables include `id`, which is the weather station ID; `date`, which is the date of observation; `prcp`, the amount of precipitation measured in mm; `snow`, the amount of snowfall measured in mm; `snwd`, the snow depth measured in mm; `tmax` and `tmin`, the maximum and minimum temperatures in degrees Celsius. A significant portion of the `ny_noaa` dataset contains missing data (values of 0 or `NA`) for its measurements of precipitation, snowfall and depth, and temperature. 

Clean NY NOAA dataset.

Create separate columns for year, month, day. Adjust variables to appropriate data types. 
```{r}
ny_noaa <- 
  ny_noaa |>  
  separate(date, into = c("year", "month", "day"), convert = TRUE) |> 
  mutate(
    tmax = as.numeric(tmax),
    tmin = as.numeric(tmin))
```

Find most commmon values for snowfall.
```{r}
ny_noaa |> 
  count(snow) |> 
  arrange(desc(n))
```

The most commonly observed values for snowfall are 0, followed by `NA`. This is because many of these observations are missing data for snowfall, either because none was recorded on that day or because the data was otherwise missing (possibly due to failure to take measurements). Following these, the next most common values are 25mm, 13mm, and 51mm. 

Two-panel plot of average max temp in January and July for all stations and all years. Note observable structures and outliers. 
```{r}
ny_noaa |>  
  group_by(id, year, month) |>  
  filter(month %in% c(1, 7)) |>  
  summarize(mean_tmax = mean(tmax, na.rm = TRUE, color = id)) |>  
  ggplot(aes(x = year, y = mean_tmax, group = id)) + geom_point() + geom_path() +
  facet_grid(~month) +
  labs(title = "Average maximum temperature in January and July in each station over the years")
```

The average maximum temperatures were consistently lower in January over the years than in July. Each station appears to follow a consistent pattern in maximum temperature recordings for a given month and year such that they all generally matched one another in magnitude of temperature. One outlier exists in July of approximately 1988 in which the temperature recorded at one station was significantly lower than the other stations at that time. In January of approximately 1983, there was a notably lower temperature recording at one station compared to other stations at that time. 

(i) tmax vs. tmin for full dataset.
```{r}
temp_hex_plot <- ny_noaa |> 
  ggplot(aes(x = tmin, y = tmax)) + 
  geom_hex()
```

(ii) plot showing distribution of snowfall values >0 and <100 separately by year.
```{r}
snowfall_ridge_plot <- ny_noaa |>  
  filter(snow < 100, snow > 0) |> 
  ggplot(aes(x = snow, y = as.factor(year))) + 
  geom_density_ridges()
```

Create two panel plot with temp_hex_plot and snowfall_ridge_plot.
```{r}
temp_hex_plot + snowfall_ridge_plot
```

## Problem 2

Load demographic and accelerometer data.
```{r}
covar <- read_csv("./data/nhanes_covar.csv")
accel <- read_csv("./data/nhanes_accel.csv")
```

Load, tidy, merge, and otherwise organize the data sets.
```{r}
covar <- 
  covar |> 
  janitor::clean_names() |> 
  rename(
    SEQN = x1, 
    sex = x1_male, 
    age = x3, 
    BMI = x4, 
    education = x1_less_than_high_school
  )
```

```{r}
covar <- 
  covar |> 
  drop_na() |> 
  filter(!(SEQN == "SEQN")) |> 
  mutate(sex = recode(sex, `1` = "male", `2` = "female"),
         education = recode(education, 
                            `1` = "Less than high school", 
                            `2` = "High school equivalent", 
                            `3` = "More than high school"), 
         age = as.numeric(age), 
         BMI = as.numeric(BMI)) |> 
  filter(age >= 21)

accel <- 
  accel |> 
  mutate(SEQN = as.character(SEQN))

covar_accel <- inner_join(covar, accel, by = "SEQN")
```

Education densities for age and sex. 
```{r}
covar_accel |> 
  janitor::tabyl(education, sex)

covar_accel |> 
  ggplot(aes(x = age, 
             y = education, 
             fill = sex)) + 
  geom_density_ridges(alpha = 0.5, 
                      scale = 0.85)
```

There were more younger females than younger males who pursued education that was more than high school. More older females than older males had a high school equivalent level of education. There were more younger males than younger females who had a high school equivalent education level. 

Total activity plots, based on sex, age, and education.
```{r}
covar_accel |> 
  group_by(SEQN, sex, age, education) |> 
  summarize(total_activity = sum(across(c(min1:min1440)))) |> 
  ggplot(aes(x = age, y = total_activity, color = sex)) + 
  geom_point() + geom_line() + geom_smooth(alpha = 0.3) + 
  facet_grid(. ~ education) + 
  theme(legend.position = "bottom")
```

Based on these plots, in general and regardless of age, females with a high school equivalent or higher education level consistently have higher overall total activity than males of the same age. Males older than age 40 with less than a high school education generally have higher overall total activity than females of the same age; for participants younger than 40 and with the same education level, females have higher total activity than males. 

24-hr plots for accelerometer. 
```{r}
covar_accel_pvlong <- 
  pivot_longer(covar_accel, 
               min1:min1440, 
               names_to = "min", 
               names_prefix = "min",
               values_to = "activity")

covar_accel_pvlong |> 
  ggplot(aes(x = min, y = activity, color = sex)) + 
  geom_point() + geom_line() + geom_smooth(alpha = 0.3) + 
  facet_grid(. ~ education) + 
  theme(legend.position = "bottom")
```

Based on these plots, both males and females with an education level of more than high school showed the highest minutes of activity compared to equivalent or below high school level, and it also showed the notable outliers among both males and females. Among all education levels and regardless of sex, there is a sharp decline in activity values toward the middle of the day, which could be an indication of when the participant is resting and/or sleeping. 

## Problem 3

Load and clean citibike data.
```{r}
citibike_jan2020 <- read_csv("./data/citibike/Jan 2020 Citi.csv") |> 
  mutate(month = "January", year = "2020")

citibike_july2020 <- read_csv("./data/citibike/July 2020 Citi.csv") |> 
  mutate(month = "July", year = "2020")

citibike_jan2024 <- read_csv("./data/citibike/Jan 2024 Citi.csv") |> 
  mutate(month = "January", year = "2024")

citibike_july2024 <- read_csv("./data/citibike/July 2024 Citi.csv") |> 
  mutate(month = "July", year = "2024")

citibike_total <- 
  rbind(citibike_jan2020, citibike_july2020, citibike_jan2024, citibike_july2024)
```

The combined dataset `citibike_total`, which contains all four datasets from January 2020 to July 2024, is comprised of `r nrow(citibike_total)` observations of `r ncol(citibike_total)` variables. Its variables include `ride_id`, the type of bike as `rideable_type`, the day of the week as `weekdays`, the ride time as `duration`, the names of the start and end stations as `start_station_name` and `end_station_name`, the designation of either a Citi Bike member or casual rider as `member_casual`, and the `month` and `year` in which the data was collected.

Citi Bike table and data description.
```{r}
citibike_total |> 
  group_by(member_casual, month, year) |> 
  summarize(n_obs = n())
```

January 2020 had the lowest number of causal riders, and July 2024 saw the highest number of causal riders. Among Citi Bike members, January 2020 had the lowest number of riders, and July 2024 had the highest number of riders. Regardless of year or membership status, there were fewer total riders in January than in July. There were also fewer total riders in January than in July, regardless of year or membership status. 

Table of 5 most popular starting stations in July 2024.
```{r}
citibike_total |> 
  filter(month == "July", year == "2024") |> 
  group_by(start_station_name) |> 
  summarize(n_obs = n()) |> 
  filter(min_rank(desc(n_obs)) < 6)
```

Plot effects of day of the week, month, year on median ride duration.
```{r}
day_order <- c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")

citibike_total |> 
  group_by(weekdays, month, year) |> 
  summarize(median_ride_duration = median(duration)) |> 
  ggplot(aes(x = factor(weekdays, day_order), y = median_ride_duration)) + 
  geom_point() + facet_grid(. ~ month + year)
```

Based on these plots, the shortest median ride durations for each day occurred in January of 2024, and the longest median ride durations for each day occurred in July of 2020. In general, Saturdays and Sundays had longer median ride durations than weekdays; the only exception was January 2024 showing that Sundays had among the shortest median ride durations out of the other days of the week. Additionally, besides January of 2020, the median ride duration generally increased as the week progressed toward the weekend. 










